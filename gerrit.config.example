# Example Gerrit Configuration for Coder Workspace Plugin
# This file shows the recommended configuration for Coder integration

[plugins]
  allowRemoteAdmin = true

[plugin "coder-workspace"]
  enabled = true

  # Coder server URL
  serverUrl = http://localhost:3000

  # Your Coder API token (store securely using Gerrit's secret management)
  apiKey = ${secret:coder/session_token}

  # Template configuration (get these values from your Coder instance)
  templateId = YOUR_TEMPLATE_ID
  # OR use templateVersionId for specific version:
  # templateVersionId = YOUR_TEMPLATE_VERSION_ID

  # Organization and user configuration
  organization = YOUR_ORGANIZATION_ID
  user = YOUR_USERNAME

  # Workspace behavior settings
  openAfterCreate = true
  enableDryRunPreview = false
  ttlMs = 0

  # Workspace naming template (tokens: {repo}, {branch}, {branchShort}, {change}, {patchset})
  workspaceNameTemplate = "{repo}-{change}-{patchset}"

  # Strict name behavior (optional)
  # When true, the plugin will create exactly the name from workspaceNameTemplate
  # without trying to reuse alternates or auto-suffix on 409. If a workspace with
  # that name already exists, it will be opened; otherwise the 409 error is surfaced.
  # strictName = false

  # Rich parameter mapping (maps Gerrit context to template parameters)
  # Default includes: REPO, BRANCH, GERRIT_CHANGE, GERRIT_PATCHSET, GERRIT_CHANGE_URL,
  # GERRIT_GIT_SSH_URL, GERRIT_CHANGE_REF
  # You can override with custom mapping if needed:
  # richParams = REPO:repo,BRANCH:branch,GERRIT_CHANGE:change,GERRIT_PATCHSET:patchset,GERRIT_CHANGE_URL:url

  # Optional per-repo/branch template overrides (JSON string)
  # templateMappingsJson = [
  #   {"repo":"my/org/*","branch":"refs/heads/main","templateVersionId":"0ba39c92-1f1b-4c32-aa3e-9925d7713eb1"},
  #   {"repo":"another/repo","branch":"refs/heads/*","templateId":"c6d67e98-83ea-49f0-8812-e4abae2b68bc"}
  # ]

  # Optional: additional name templates to try when looking up existing workspaces
  # These are lookup-only; they are not used for creation.
  # To force exact-name creation and avoid reuse, either set strictName=true or
  # remove alternates entirely (or keep only {repo}-{change}).
  # alternateNameTemplates = {repo}.{branchShort}, {repo}-{branch}
  # or, as JSON (takes precedence if both are set):
  # alternateNameTemplatesJson = ["{repo}.{branchShort}", "{repo}-{branch}"]

  # Optional: preferred app to open when latest_app_status.uri is not provided by API
  # appSlug = code-server

  # Optional: wait for app readiness before opening (0 disables waiting)
  # waitForAppReadyMs = 15000
  # waitPollIntervalMs = 1000

  # Cross-browser authentication helpers (optional)
  # Retries API requests with the API token as a query parameter on 401/network errors
  retryAuthWithQueryParam = true
  # Name of the query parameter for the token if retried
  apiKeyQueryParamName = coder_session_token
  # Append token to app deeplink URL when opening (use only in trusted environments)
  appendTokenToAppUrl = false

  # On popup-block: navigate in the same tab as a fallback
  navigateInSameTabOnBlock = true
